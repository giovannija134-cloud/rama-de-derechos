import React, { useState, useEffect, useRef } from 'react';
import { Book, Network, MessageSquare, Gavel, ExternalLink, ChevronDown, ChevronRight, User, Bot, Send, Search, Info } from 'lucide-react';

/* DATA: Información estructurada sobre las ramas del derecho
  Fuente de investigación compilada para la actividad.
*/
const legalData = {
  publico: {
    title: "Derecho Público",
    color: "bg-blue-100 text-blue-800",
    borderColor: "border-blue-500",
    description: "Regula las relaciones entre el Estado y los particulares, o entre los órganos del Estado entre sí.",
    subbranches: [
      {
        name: "Derecho Constitucional",
        concept: "Conjunto de normas que establecen los principios fundamentales del Estado, la organización de los poderes y los derechos humanos.",
        example: "El juicio de amparo para proteger los derechos fundamentales de un ciudadano.",
        source: "Constitución Política de los Estados Unidos Mexicanos (Art. 1-29)."
      },
      {
        name: "Derecho Administrativo",
        concept: "Regula la organización, funcionamiento, poderes y deberes de la Administración Pública.",
        example: "La solicitud y expedición de una licencia de construcción ante el municipio.",
        source: "Ley Federal de Procedimiento Administrativo."
      },
      {
        name: "Derecho Penal",
        concept: "Normas que definen los delitos, las penas y las medidas de seguridad para mantener el orden social.",
        example: "El proceso judicial contra una persona acusada de robo calificado.",
        source: "Código Penal Federal / Código Nacional de Procedimientos Penales."
      },
      {
        name: "Derecho Procesal",
        concept: "Regula los procedimientos que deben seguirse ante los tribunales para la aplicación del derecho sustantivo.",
        example: "Las etapas de un juicio oral (audiencia inicial, intermedia y juicio).",
        source: "Teoría General del Proceso (Cipriano Gómez Lara)."
      },
      {
        name: "Derecho Internacional Público",
        concept: "Rige las relaciones entre los Estados y otros sujetos internacionales (organismos).",
        example: "La firma de tratados comerciales como el T-MEC entre países.",
        source: "Carta de las Naciones Unidas."
      }
    ]
  },
  privado: {
    title: "Derecho Privado",
    color: "bg-purple-100 text-purple-800",
    borderColor: "border-purple-500",
    description: "Regula las relaciones entre particulares, donde el Estado interviene solo como garante de la legalidad.",
    subbranches: [
      {
        name: "Derecho Civil",
        concept: "Regula las relaciones personales o patrimoniales entre personas privadas (físicas o jurídicas).",
        example: "Un contrato de compraventa de una casa o un divorcio.",
        source: "Código Civil Federal (Libro Cuarto: De las Obligaciones)."
      },
      {
        name: "Derecho Mercantil",
        concept: "Regula los actos de comercio y el estatuto de los empresarios o comerciantes.",
        example: "La constitución de una Sociedad Anónima (S.A.) para un negocio.",
        source: "Código de Comercio / Ley General de Sociedades Mercantiles."
      },
      {
        name: "Derecho Internacional Privado",
        concept: "Resuelve conflictos de jurisdicción y leyes aplicables en situaciones que involucran a más de un país entre particulares.",
        example: "Un matrimonio entre un mexicano y una francesa que desean divorciarse viviendo en España.",
        source: "Ley de Nacionalidad."
      },
      {
        name: "Derecho Bancario",
        concept: "Normas que regulan la estructura y funcionamiento de las entidades bancarias y sus operaciones con clientes.",
        example: "La regulación de las tasas de interés de las tarjetas de crédito.",
        source: "Ley de Instituciones de Crédito."
      },
      {
        name: "Derecho Bursátil",
        concept: "Regula el mercado de valores, las bolsas de valores y las ofertas públicas de inversión.",
        example: "La compra de acciones de una empresa pública en la Bolsa Mexicana de Valores.",
        source: "Ley del Mercado de Valores."
      }
    ]
  },
  social: {
    title: "Derecho Social",
    color: "bg-emerald-100 text-emerald-800",
    borderColor: "border-emerald-500",
    description: "Normas que protegen a los grupos socialmente vulnerables para lograr la equidad.",
    subbranches: [
      {
        name: "Derecho Laboral",
        concept: "Regula las relaciones entre trabajadores y patrones, buscando el equilibrio de los factores de producción.",
        example: "Una demanda por despido injustificado exigiendo indemnización.",
        source: "Ley Federal del Trabajo (Art. 123 Constitucional)."
      },
      {
        name: "Derecho Agrario",
        concept: "Regula la tenencia de la tierra, la propiedad ejidal y comunal y la explotación agrícola.",
        example: "La sucesión de derechos parcelarios de un ejidatario a su hijo.",
        source: "Ley Agraria."
      },
      {
        name: "Derecho de la Seguridad Social",
        concept: "Protege a los individuos ante contingencias (vejez, enfermedad, desempleo) garantizando bienestar.",
        example: "El trámite de una pensión por cesantía en edad avanzada ante el IMSS.",
        source: "Ley del Seguro Social."
      },
      {
        name: "Derecho Ambiental",
        concept: "Normas destinadas a la protección, preservación y restauración del medio ambiente.",
        example: "Sanciones a una fábrica por verter desechos tóxicos en un río.",
        source: "Ley General del Equilibrio Ecológico y la Protección al Ambiente."
      },
      {
        name: "Derecho Migratorio",
        concept: "Regula el tránsito internacional de personas y su estancia en el territorio nacional.",
        example: "La obtención de una visa de residencia temporal por oferta de empleo.",
        source: "Ley de Migración."
      }
    ]
  }
};

/* --- COMPONENTS --- */

// 1. Research Component
const ResearchSection = () => {
  const [openSection, setOpenSection] = useState('publico');

  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center">
          <Book className="w-6 h-6 mr-2 text-indigo-600" />
          Investigación Académica
        </h2>
        <p className="text-slate-600 mb-6">
          A continuación se presenta el análisis detallado de las tres grandes ramas del derecho, 
          incluyendo sus subramas, conceptos clave, ejemplos prácticos y fuentes de consulta.
        </p>

        <div className="grid gap-6">
          {Object.entries(legalData).map(([key, branch]) => (
            <div key={key} className={`border rounded-lg overflow-hidden transition-all duration-300 ${openSection === key ? 'ring-2 ring-offset-2 ring-indigo-100' : ''}`}>
              <button 
                onClick={() => setOpenSection(openSection === key ? null : key)}
                className={`w-full flex items-center justify-between p-4 ${branch.color} font-bold text-lg`}
              >
                <span>{branch.title}</span>
                {openSection === key ? <ChevronDown /> : <ChevronRight />}
              </button>
              
              {openSection === key && (
                <div className="bg-white p-4">
                  <p className="mb-4 text-slate-700 italic border-l-4 border-slate-300 pl-4 py-2">
                    {branch.description}
                  </p>
                  <div className="grid gap-4 md:grid-cols-1 lg:grid-cols-2">
                    {branch.subbranches.map((sub, idx) => (
                      <div key={idx} className="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-slate-50">
                        <h3 className={`font-bold text-lg mb-2 ${branch.color.split(" ")[1]}`}>{sub.name}</h3>
                        
                        <div className="space-y-3 text-sm">
                          <div>
                            <span className="font-semibold text-slate-900 block">Concepto:</span>
                            <span className="text-slate-700">{sub.concept}</span>
                          </div>
                          <div>
                            <span className="font-semibold text-slate-900 block">Ejemplo:</span>
                            <span className="text-slate-700">{sub.example}</span>
                          </div>
                          <div className="flex items-start mt-2 text-xs text-slate-500 bg-white p-2 rounded border border-slate-100">
                            <ExternalLink className="w-3 h-3 mr-1 mt-0.5 flex-shrink-0" />
                            <span>Fuente: {sub.source}</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// 2. Mind Map Component
const MindMapSection = () => {
  const [selectedNode, setSelectedNode] = useState(null);

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-[800px] flex flex-col">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-2xl font-bold text-slate-800 flex items-center">
            <Network className="w-6 h-6 mr-2 text-indigo-600" />
            Mapa Mental Interactivo
          </h2>
          <span className="text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
            Haz clic en las ramas para explorar
          </span>
        </div>

        <div className="flex-1 relative bg-slate-50 rounded-xl overflow-hidden border border-slate-200 shadow-inner flex items-center justify-center">
           
           {/* SVG Lines Layer */}
           <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
             {/* Main Connections */}
             <line x1="50%" y1="50%" x2="20%" y2="30%" stroke="#3b82f6" strokeWidth="3" strokeDasharray="5,5" />
             <line x1="50%" y1="50%" x2="80%" y2="30%" stroke="#a855f7" strokeWidth="3" strokeDasharray="5,5" />
             <line x1="50%" y1="50%" x2="50%" y2="80%" stroke="#10b981" strokeWidth="3" strokeDasharray="5,5" />
             
             {/* Sub-connections (Simplified visual representation) */}
             <circle cx="50%" cy="50%" r="60" fill="none" stroke="#e2e8f0" strokeWidth="1" />
           </svg>

           {/* Central Node */}
           <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
             <button 
                onClick={() => setSelectedNode('main')}
                className="w-32 h-32 rounded-full bg-slate-900 text-white flex flex-col items-center justify-center shadow-xl hover:scale-105 transition-transform ring-4 ring-indigo-100"
             >
                <Gavel className="w-8 h-8 mb-2" />
                <span className="font-bold text-lg">DERECHO</span>
             </button>
           </div>

           {/* Branch: Publico */}
           <div className="absolute top-[30%] left-[20%] transform -translate-x-1/2 -translate-y-1/2 z-10 text-center">
              <button 
                onClick={() => setSelectedNode('publico')}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700 transition-all mb-4"
              >
                Derecho Público
              </button>
              {selectedNode === 'publico' && (
                <div className="flex flex-col gap-2 animate-fadeInDown">
                  {legalData.publico.subbranches.map(sub => (
                    <span key={sub.name} className="bg-blue-100 text-blue-900 px-3 py-1 rounded text-xs font-semibold shadow-sm border border-blue-200">
                      {sub.name}
                    </span>
                  ))}
                </div>
              )}
           </div>

           {/* Branch: Privado */}
           <div className="absolute top-[30%] left-[80%] transform -translate-x-1/2 -translate-y-1/2 z-10 text-center">
              <button 
                onClick={() => setSelectedNode('privado')}
                className="bg-purple-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-purple-700 transition-all mb-4"
              >
                Derecho Privado
              </button>
              {selectedNode === 'privado' && (
                <div className="flex flex-col gap-2 animate-fadeInDown">
                  {legalData.privado.subbranches.map(sub => (
                    <span key={sub.name} className="bg-purple-100 text-purple-900 px-3 py-1 rounded text-xs font-semibold shadow-sm border border-purple-200">
                      {sub.name}
                    </span>
                  ))}
                </div>
              )}
           </div>

           {/* Branch: Social */}
           <div className="absolute top-[80%] left-[50%] transform -translate-x-1/2 -translate-y-1/2 z-10 text-center">
              <div className="flex flex-col-reverse items-center">
                <button 
                  onClick={() => setSelectedNode('social')}
                  className="bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-emerald-700 transition-all mt-4"
                >
                  Derecho Social
                </button>
                {selectedNode === 'social' && (
                  <div className="flex flex-wrap justify-center gap-2 max-w-xs animate-fadeInUp">
                    {legalData.social.subbranches.map(sub => (
                      <span key={sub.name} className="bg-emerald-100 text-emerald-900 px-3 py-1 rounded text-xs font-semibold shadow-sm border border-emerald-200">
                        {sub.name}
                      </span>
                    ))}
                  </div>
                )}
              </div>
           </div>

        </div>
        
        {/* Info Panel for Mind Map */}
        <div className="mt-4 p-4 bg-slate-50 border rounded-lg text-sm text-slate-600 flex items-start">
          <Info className="w-5 h-5 mr-2 text-slate-400 flex-shrink-0" />
          <p>
            Este mapa mental representa la jerarquía clásica. El Derecho (centro) se divide en tres grandes ramas. 
            Haz clic en los botones de colores para desplegar las 5 subramas investigadas de cada categoría.
          </p>
        </div>
      </div>
    </div>
  );
};

// 3. AI Advisor Component
const AIAdvisorSection = () => {
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState([
    { 
      role: 'model', 
      text: 'Hola. Soy tu Asesor Legal Académico (IA). Puedo ayudarte a profundizar en las ramas del derecho, analizar casos hipotéticos o clarificar conceptos para tu tarea. ¿En qué puedo ayudarte hoy?' 
    }
  ]);
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(scrollToBottom, [messages]);

  const handleSend = async () => {
    if (!input.trim()) return;

    const userMessage = { role: 'user', text: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);

    try {
      const apiKey = ""; // API Key injected by environment
      const systemInstruction = "Eres un Asesor Legal Académico experto en Derecho Mexicano y teoría general del derecho. Tu objetivo es ayudar a estudiantes a comprender conceptos, diferenciar ramas del derecho y analizar ejemplos. NO das consejos legales reales para litigios, siempre aclaras que eres una herramienta educativa. Tus respuestas son claras, estructuradas y citan fuentes generales (leyes, constitución) cuando es posible. Eres amable y fomentas el pensamiento crítico.";
      
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: input }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] }
        })
      });

      if (!response.ok) throw new Error('Error en la conexión con la IA');

      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar tu solicitud en este momento.";
      
      setMessages(prev => [...prev, { role: 'model', text: aiText }]);
    } catch (error) {
      console.error(error);
      setMessages(prev => [...prev, { role: 'model', text: "Hubo un error al conectar con el asesor. Por favor intenta de nuevo." }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-200 h-[600px] flex flex-col overflow-hidden animate-fadeIn">
      <div className="bg-slate-900 p-4 text-white flex items-center justify-between">
        <div className="flex items-center">
          <div className="bg-indigo-500 p-2 rounded-lg mr-3">
             <Bot className="w-6 h-6 text-white" />
          </div>
          <div>
            <h2 className="font-bold text-lg">Asesor Legal IA</h2>
            <p className="text-xs text-slate-400">Especialista en Derecho Académico</p>
          </div>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
             <div className={`max-w-[80%] p-4 rounded-xl shadow-sm ${
               msg.role === 'user' 
               ? 'bg-indigo-600 text-white rounded-br-none' 
               : 'bg-white text-slate-800 border border-slate-200 rounded-bl-none'
             }`}>
               <div className="text-sm leading-relaxed whitespace-pre-wrap">{msg.text}</div>
             </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-white p-4 rounded-xl border border-slate-200 rounded-bl-none flex items-center space-x-2">
              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      <div className="p-4 bg-white border-t border-slate-200">
        <div className="flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSend()}
            placeholder="Pregunta sobre una rama del derecho, pide un ejemplo o aclara un concepto..."
            className="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
            disabled={isLoading}
          />
          <button 
            onClick={handleSend}
            disabled={isLoading || !input.trim()}
            className="bg-indigo-600 text-white px-6 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center"
          >
            <Send className="w-5 h-5" />
          </button>
        </div>
        <p className="text-xs text-center text-slate-400 mt-2">
          La IA puede cometer errores. Verifica siempre en las fuentes oficiales (Leyes y Códigos).
        </p>
      </div>
    </div>
  );
};

export default function App() {
  const [activeTab, setActiveTab] = useState('research');

  return (
    <div className="min-h-screen bg-slate-100 font-sans text-slate-900 pb-12">
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div className="max-w-5xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
          <div className="flex items-center space-x-3 mb-4 md:mb-0">
            <div className="bg-indigo-600 p-2 rounded-lg text-white">
              <Gavel className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-800">Introducción al Estudio del Derecho</h1>
              <p className="text-xs text-slate-500">Actividad: Clasificación de las Ramas Jurídicas</p>
            </div>
          </div>
          
          <nav className="flex space-x-2 bg-slate-100 p-1 rounded-lg">
            <button 
              onClick={() => setActiveTab('research')}
              className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'research' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}
            >
              <Book className="w-4 h-4 mr-2" />
              Investigación
            </button>
            <button 
              onClick={() => setActiveTab('map')}
              className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'map' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}
            >
              <Network className="w-4 h-4 mr-2" />
              Mapa Mental
            </button>
            <button 
              onClick={() => setActiveTab('ai')}
              className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'ai' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}
            >
              <MessageSquare className="w-4 h-4 mr-2" />
              Asesor IA
            </button>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto px-4 py-8">
        {activeTab === 'research' && <ResearchSection />}
        {activeTab === 'map' && <MindMapSection />}
        {activeTab === 'ai' && <AIAdvisorSection />}
      </main>

      <style>{`
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .animate-fadeInDown { animation: fadeInDown 0.3s ease-out; }
        .animate-fadeInUp { animation: fadeInUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>
    </div>
  );
}
